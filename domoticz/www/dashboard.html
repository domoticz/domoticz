<div id="dashcontent">
</div>

<script type="text/javascript" charset="utf-8">

function RefreshFavorites()
{
  clearInterval($.myglobals.refreshTimer);
  var id="";
  $.ajax({
     url: "json.htm?type=devices&filter=all&used=true&order=Name",
     async: false,
     dataType: 'json',
     success: function(data) {
      if (typeof data.result != 'undefined') {
        //light devices
        $.each(data.result, function(i,item){
          if ((item.Type.indexOf('Light') == 0)&&(item.Favorite!=0))
          {
						id="#dashcontent #light_" + item.idx;
						var obj=$(id);
						if (typeof obj != 'undefined') {
							$(id + " #name").html(item.Name);
							if (item.SwitchType == "Doorbell") {
								$(id + " #img").html('<img src="images/door48.png" height="40" title="Turn On" onclick="SwitchLight(' + item.idx + ',\'On\',ShowFavorites);" onMouseover="cursorhand()" onMouseout="cursordefault()">');
							}
							else if (item.SwitchType == "X10 Siren") {
								$(id + " #img").html('<img src="images/siren48.png" height="40">');
							}
							else if (item.SwitchType == "Contact") {
								$(id + " #img").html('<img src="images/contact48.png" height="40">');
							}
							else if (item.SwitchType == "Blinds") {
								if (item.Status == 'Closed') {
										$(id + " #img").html('<img src="images/blinds48.png" height="40" title="Open Blinds" onclick="SwitchLight(' + item.idx + ',\'Off\',ShowFavorites);" onMouseover="cursorhand()" onMouseout="cursordefault()">');
								}
								else {
										$(id + " #img").html('<img src="images/blindsopen48.png" height="40" title="Close Blinds" onclick="SwitchLight(' + item.idx + ',\'On\',ShowFavorites);" onMouseover="cursorhand()" onMouseout="cursordefault()">');
								}
							}
							else {
								if (
										(item.Status == 'On')||
										(item.Status == 'Chime')||
										(item.Status == 'Group On')||
										(item.Status.indexOf('Set ') == 0)
									 ) {
											$(id + " #img").html('<img src="images/light-on.png" height="40" title="Turn Off" onclick="SwitchLight(' + item.idx + ',\'Off\',ShowFavorites);" onMouseover="cursorhand()" onMouseout="cursordefault()">');
								}
								else {
											$(id + " #img").html('<img src="images/light-off.png" height="40" title="Turn On" onclick="SwitchLight(' + item.idx + ',\'On\',ShowFavorites);" onMouseover="cursorhand()" onMouseout="cursordefault()">');
								}
							}
							$(id + " #status").html(item.Status);
							$(id + " #lastupdate").html(item.LastUpdate);
						}
					}
				}); //light devices
				
        //Temperature Sensors
        $.each(data.result, function(i,item){
          if (
                ((typeof item.Temp != 'undefined')||(typeof item.Humidity != 'undefined')) &&
                (item.Favorite!=0)
              )
          {
						id="#dashcontent #temp_" + item.idx;
						var obj=$(id);
						if (typeof obj != 'undefined') {
							$(id + " #name").html(item.Name);
							var img='<img src="images/';
							if ((typeof item.Temp == 'undefined') || (item.Temp>0)) {
								img+='temp48.png';
							}
							else {
								img+='ice.png';
							}
							img+='" height="40">';
							$(id + " #img").html(img);
							var status="";
							var bHaveBefore=false;
							if (typeof item.Temp != 'undefined') {
									 status+=item.Temp + '&deg; C';
									 bHaveBefore=true;
							}
							if (typeof item.Chill != 'undefined') {
								status+=', Chill: ' + item.Chill + '&deg; C';
								bHaveBefore=true;
							}
							if (typeof item.Direction != 'undefined') {
								status+='<br>' + item.Direction + ' ' + item.DirectionStr + ', Speed: ' + item.Speedms + ' ms, Gust: ' + item.Gustms + ' ms\n';
							}
							if (typeof item.Humidity != 'undefined') {
								if (bHaveBefore==true) {
									status+=', ';
								}
								status+='Humidity: ' + item.Humidity + ' %';
							}
							if (typeof item.HumidityStatus != 'undefined') {
								status+=' (' + item.HumidityStatus + ')';
							}
							if (typeof item.Barometer != 'undefined') {
								status+='<br>' + item.Barometer + ' hPa';
							}
							if (typeof item.ForecastStr != 'undefined') {
								status+=', Prediction: ' + item.ForecastStr;
							}
							$(id + " #status").html(status);
							$(id + " #lastupdate").html(item.LastUpdate);
						}
          }
        }); //temp devices
        
        //Weather Sensors
        $.each(data.result, function(i,item){
          if (
                ( (typeof item.Rain != 'undefined') || (typeof item.UVI != 'undefined') || (typeof item.Direction != 'undefined') ) &&
                (item.Favorite!=0)
              )
          {
						id="#dashcontent #weather_" + item.idx;
						var obj=$(id);
						if (typeof obj != 'undefined') {
							$(id + " #name").html(item.Name);
							if (typeof item.Rain != 'undefined') {
								$(id + " #img").html('<img src="images/rain48.png" height="40">');
								var status=item.Rain + ' mm';
								if (typeof item.RainRate != 'undefined') {
									if (item.RainRate!=0) {
										status+=', Rate: ' + item.RainRate + ' mm/h';
									}
								}
								$(id + " #status").html(status);
							}
							else if (typeof item.UVI != 'undefined') {
								$(id + " #img").html('<img src="images/uv48.png" height="40">');
								var status=item.UVI + ' UVI';
								if (typeof item.Temp!= 'undefined') {
									status+=', Temp: ' + item.Temp + '&deg; C';
								}
								$(id + " #status").html(status);
							}
							else if (typeof item.Direction != 'undefined') {
								$(id + " #img").html('<img src="images/wind48.png" height="40">');
								var status=item.Direction + ' ' + item.DirectionStr + ', Speed: ' + item.Speedms + ' ms, Gust: ' + item.Gustms + ' ms<br>\n';
								status+='Temp: ' + item.Temp + '&deg; C, ';
								status+='Chill: ' + item.Chill + '&deg; C';
								$(id + " #status").html(status);
							}
							$(id + " #lastupdate").html(item.LastUpdate);
						}
          }
        }); //weather devices
        
        //security devices
        $.each(data.result, function(i,item){
          if ((item.Type.indexOf('Security') == 0)&&(item.Favorite!=0))
          {
						id="#dashcontent #security_" + item.idx;
						var obj=$(id);
						if (typeof obj != 'undefined') {
							$(id + " #name").html(item.Name);
							if (item.SubType.indexOf('remote') > 0) {
								$(id + " #img").html('<img src="images/remote48.png" height="40">');
							}
							else {
								if ((item.Status.indexOf('Alarm') >= 0)||(item.Status.indexOf('Tamper') >= 0)) {
									$(id + " #img").html('<img src="images/alarm48.png" height="40">');
								}
								else {
									$(id + " #img").html('<img src="images/security48.png" height="40">');
								}
							}
							$(id + " #status").html(item.Status);
							$(id + " #lastupdate").html(item.LastUpdate);
						}
          }
        }); //security devices
        
        //Utility Sensors
        $.each(data.result, function(i,item){
          if (
                ( (typeof item.Counter != 'undefined') ) &&
                (item.Favorite!=0)
              )
          {
						id="#dashcontent #utility_" + item.idx;
						var obj=$(id);
						if (typeof obj != 'undefined') {
							$(id + " #name").html(item.Name);
							$(id + " #img").html('<img src="images/counter.png" height="40">');
							$(id + " #status").html(item.Counter + ', Today: ' + item.CounterToday);
							$(id + " #lastupdate").html(item.LastUpdate);
						}
          }
        }); //Utility devices
      }
     }
  });

  $.myglobals.refreshTimer = setInterval(RefreshFavorites, 10000);
}

function ShowFavorites()
{
  clearInterval($.myglobals.refreshTimer);
  var totdevices=0;
  var jj=0;
  var bHaveAddedDevider = false;

	var htmlcontent = "";

  var sunRise="";
  var sunSet="";

  $.ajax({
     url: "json.htm?type=command&param=getSunRiseSet",
     async: false, 
     dataType: 'json',
     success: function(data) {
        if (typeof data.Sunrise != 'undefined') {
          sunRise=data.Sunrise;
          sunSet=data.Sunset;
        }
     }
  });

  $.ajax({
     url: "json.htm?type=devices&filter=all&used=true&order=Name",
     async: false,
     dataType: 'json',
     success: function(data) {
					var rowItems=3;
					if (data.DashboardType==1) {
						rowItems=4;
					}

      if (typeof data.result != 'undefined') {
        //light devices
        bHaveAddedDevider = false;
        $.each(data.result, function(i,item){
          if ((item.Type.indexOf('Light') == 0)&&(item.Favorite!=0))
          {
            totdevices+=1;
            if (jj == 0)
            {
              //first time
              htmlcontent+='<h2>Light/Switch Devices:</h2>\n';
            }
            if (jj % rowItems == 0)
            {
              //add devider
              if (bHaveAddedDevider == true) {
                //close previous devider
                htmlcontent+='</div>\n';
              }
              htmlcontent+='<div class="row divider">\n';
              bHaveAddedDevider=true;
            }
            
            var xhtm="";
            if (data.DashboardType==0) {
							xhtm='\t<div class="4u" id="light_' + item.idx +'">\n';
            }
            else {
							xhtm='\t<div class="3u" id="light_' + item.idx +'">\n';
            }
				
						xhtm+=
								'\t  <section>\n' +
								'\t    <table id="itemtablesmall" border="0" cellpadding="0" cellspacing="0">\n' +
								'\t    <tr>\n' +
								'\t      <td id="name">' + item.Name + '</td>\n';
            if (item.SwitchType == "Doorbell") {
              xhtm+='\t      <td id="img"><img src="images/door48.png" height="40" title="Turn On" onclick="SwitchLight(' + item.idx + ',\'On\',ShowFavorites);" onMouseover="cursorhand()" onMouseout="cursordefault()"></td>\n';
            }
            else if (item.SwitchType == "X10 Siren") {
              xhtm+='\t      <td id="img"><img src="images/siren48.png" height="40"></td>\n';
            }
            else if (item.SwitchType == "Contact") {
              xhtm+='\t      <td id="img"><img src="images/contact48.png" height="40"></td>\n';
            }
						else if (item.SwitchType == "Blinds") {
							if (item.Status == 'Closed') {
									xhtm+='\t      <td id="img"><img src="images/blinds48.png" height="40" title="Open Blinds" onclick="SwitchLight(' + item.idx + ',\'Off\',ShowFavorites);" onMouseover="cursorhand()" onMouseout="cursordefault()"></td>\n';
							}
							else {
									xhtm+='\t      <td id="img"><img src="images/blindsopen48.png" height="40" title="Close Blinds" onclick="SwitchLight(' + item.idx + ',\'On\',ShowFavorites);" onMouseover="cursorhand()" onMouseout="cursordefault()"></td>\n';
							}
						}
            else {
              if (
                  (item.Status == 'On')||
                  (item.Status == 'Chime')||
                  (item.Status == 'Group On')||
                  (item.Status.indexOf('Set ') == 0)
                 ) {
                    xhtm+='\t      <td id="img"><img src="images/light-on.png" height="40" title="Turn Off" onclick="SwitchLight(' + item.idx + ',\'Off\',ShowFavorites);" onMouseover="cursorhand()" onMouseout="cursordefault()"></td>\n';
              }
              else {
                    xhtm+='\t      <td id="img"><img src="images/light-off.png" height="40" title="Turn On" onclick="SwitchLight(' + item.idx + ',\'On\',ShowFavorites);" onMouseover="cursorhand()" onMouseout="cursordefault()"></td>\n';
              }
            }
            xhtm+=
                  '\t      <td id="status">' + item.Status + '</td>\n' +
                  '\t      <td id="lastupdate">' + item.LastUpdate + '</td>\n' +
                  '\t    </tr>\n' +
                  '\t    </table>\n' +
                  '\t  </section>\n' +
                  '\t</div>\n';
            htmlcontent+=xhtm;
            jj+=1;
          }
        }); //light devices
        if (bHaveAddedDevider == true) {
          //close previous devider
          htmlcontent+='</div>\n';
        }

        //Temperature Sensors
        jj=0;
        bHaveAddedDevider = false;
        $.each(data.result, function(i,item){
          if (
                ((typeof item.Temp != 'undefined')||(typeof item.Humidity != 'undefined')) &&
                (item.Favorite!=0)
              )
          {
            totdevices+=1;
            if (jj == 0)
            {
              //first time
              htmlcontent+='<h2>Temperature Sensors:</h2>\n';
            }
            if (jj % rowItems == 0)
            {
              //add devider
              if (bHaveAddedDevider == true) {
                //close previous devider
                htmlcontent+='</div>\n';
              }
              htmlcontent+='<div class="row divider">\n';
              bHaveAddedDevider=true;
            }
            var xhtm="";
            if (data.DashboardType==0) {
							xhtm='\t<div class="4u" id="temp_' + item.idx +'">\n';
            }
            else {
							xhtm='\t<div class="3u" id="temp_' + item.idx +'">\n';
            }
            xhtm+='\t  <section>\n' +
                  '\t    <table id="itemtablesmall" border="0" cellpadding="0" cellspacing="0">\n' +
                  '\t    <tr>\n' +
                  '\t      <td id="name">' + item.Name + '</td>\n' +
                  '\t      <td id="img"><img src="images/';
                  if ((typeof item.Temp == 'undefined') || (item.Temp>0)) {
                    xhtm+='temp48.png';
                  }
                  else {
                    xhtm+='ice.png';
                  }
                  xhtm+='" height="40"></td>\n' +
                      '\t      <td id="status">';
                  var bHaveBefore=false;
                  if (typeof item.Temp != 'undefined') {
                       xhtm+=item.Temp + '&deg; C';
                       bHaveBefore=true;
                  }
                  if (typeof item.Chill != 'undefined') {
                    xhtm+=', Chill: ' + item.Chill + '&deg; C';
                    bHaveBefore=true;
                  }
									if (typeof item.Direction != 'undefined') {
										xhtm+='<br>' + item.Direction + ' ' + item.DirectionStr + ', Speed: ' + item.Speedms + ' ms, Gust: ' + item.Gustms + ' ms\n';
									}
                  if (typeof item.Humidity != 'undefined') {
										if (bHaveBefore==true) {
											xhtm+=', ';
										}
                    xhtm+='Humidity: ' + item.Humidity + ' %';
                  }
                  if (typeof item.HumidityStatus != 'undefined') {
                    xhtm+=' (' + item.HumidityStatus + ')';
                  }
                  if (typeof item.Barometer != 'undefined') {
                    xhtm+='<br>' + item.Barometer + ' hPa';
                  }
                  if (typeof item.ForecastStr != 'undefined') {
                    xhtm+=', Prediction: ' + item.ForecastStr;
                  }
                  xhtm+=
                      '</td>\n' +
                      '\t      <td id="lastupdate">' + item.LastUpdate + '</td>\n' +
                  '\t    </tr>\n' +
                  '\t    </table>\n' +
                  '\t  </section>\n' +
                  '\t</div>\n';
            htmlcontent+=xhtm;
            jj+=1;
          }
        }); //temp devices
        if (bHaveAddedDevider == true) {
          //close previous devider
          htmlcontent+='</div>\n';
        }

        //Weather Sensors
        jj=0;
        bHaveAddedDevider = false;
        $.each(data.result, function(i,item){
          if (
                ( (typeof item.Rain != 'undefined') || (typeof item.UVI != 'undefined') || (typeof item.Direction != 'undefined') ) &&
                (item.Favorite!=0)
              )
          {
            totdevices+=1;
            if (jj == 0)
            {
              //first time
              htmlcontent+='<h2>Weather Sensors:</h2>\n';
            }
            if (jj % rowItems == 0)
            {
              //add devider
              if (bHaveAddedDevider == true) {
                //close previous devider
                htmlcontent+='</div>\n';
              }
              htmlcontent+='<div class="row divider">\n';
              bHaveAddedDevider=true;
            }
            var xhtm="";
            if (data.DashboardType==0) {
							xhtm='\t<div class="4u" id="weather_' + item.idx +'">\n';
            }
            else {
							xhtm='\t<div class="3u" id="weather_' + item.idx +'">\n';
            }
            xhtm+='\t  <section>\n' +
                  '\t    <table id="itemtablesmall" border="0" cellpadding="0" cellspacing="0">\n' +
                  '\t    <tr>\n' +
                  '\t      <td id="name">' + item.Name + '</td>\n' +
                  '\t      <td id="img"><img src="images/';
                  if (typeof item.Rain != 'undefined') {
                    xhtm+='rain48.png" height="40"></td>\n' +
                    '\t      <td>' + item.Rain + ' mm';
                    if (typeof item.RainRate != 'undefined') {
											if (item.RainRate!=0) {
												xhtm+=', Rate: ' + item.RainRate + ' mm/h';
											}
                    }
                  }
                  else if (typeof item.UVI != 'undefined') {
                    xhtm+='uv48.png" height="40"></td>\n' +
                    '\t      <td>' + item.UVI + ' UVI';
                    if (typeof item.Temp!= 'undefined') {
                      xhtm+=', Temp: ' + item.Temp + '&deg; C';
                    }
                  }
                  else if (typeof item.Direction != 'undefined') {
                    xhtm+='wind48.png" height="40"></td>\n' +
                    '\t      <td id="status">' + item.Direction + ' ' + item.DirectionStr + ', Speed: ' + item.Speedms + ' ms, Gust: ' + item.Gustms + ' ms<br>\n';
                    xhtm+='Temp: ' + item.Temp + '&deg; C, ';
                    xhtm+='Chill: ' + item.Chill + '&deg; C';
                  }
                  xhtm+=
                      '</td>\n' +
                      '\t      <td id="lastupdate">' + item.LastUpdate + '</td>\n' +
                  '\t    </tr>\n' +
                  '\t    </table>\n' +
                  '\t  </section>\n' +
                  '\t</div>\n';
            htmlcontent+=xhtm;
            jj+=1;
          }
        }); //weather devices
        if (bHaveAddedDevider == true) {
          //close previous devider
          htmlcontent+='</div>\n';
        }

        //security devices
        jj=0;
        bHaveAddedDevider = false;
        $.each(data.result, function(i,item){
          if ((item.Type.indexOf('Security') == 0)&&(item.Favorite!=0))
          {
            totdevices+=1;
            if (jj == 0)
            {
              //first time
              htmlcontent+='<h2>Security Devices:</h2>\n';
            }
            if (jj % rowItems == 0)
            {
              //add devider
              if (bHaveAddedDevider == true) {
                //close previous devider
                htmlcontent+='</div>\n';
              }
              htmlcontent+='<div class="row divider">\n';
              bHaveAddedDevider=true;
            }
            var xhtm="";
            if (data.DashboardType==0) {
							xhtm='\t<div class="4u" id="security_' + item.idx +'">\n';
            }
            else {
							xhtm='\t<div class="3u" id="security_' + item.idx +'">\n';
            }
            xhtm+='\t  <section>\n' +
                  '\t    <table id="itemtablesmall" border="0" cellpadding="0" cellspacing="0">\n' +
                  '\t    <tr>\n' +
                  '\t      <td id="name">' + item.Name + '</td>\n';
						if (item.SubType.indexOf('remote') > 0) {
							xhtm+='\t      <td id="img"><img src="images/remote48.png" height="40"></td>\n';
						}
						else {
							if ((item.Status.indexOf('Alarm') >= 0)||(item.Status.indexOf('Tamper') >= 0)) {
								xhtm+='\t      <td id="img"><img src="images/alarm48.png" height="40"></td>\n';
							}
							else {
								xhtm+='\t      <td id="img"><img src="images/security48.png" height="40"></td>\n';
							}
						}
            xhtm+=
                  '\t      <td id="status">' + item.Status + '</td>\n' +
                  '\t      <td id="lastupdate">' + item.LastUpdate + '</td>\n' +
                  '\t    </tr>\n' +
                  '\t    </table>\n' +
                  '\t  </section>\n' +
                  '\t</div>\n';
            htmlcontent+=xhtm;
            jj+=1;
          }
        }); //security devices
        if (bHaveAddedDevider == true) {
          //close previous devider
          htmlcontent+='</div>\n';
        }
        
        //Utility Sensors
        jj=0;
        bHaveAddedDevider = false;
        $.each(data.result, function(i,item){
          if (
                ( (typeof item.Counter != 'undefined') ) &&
                (item.Favorite!=0)
              )
          {
            totdevices+=1;
            if (jj == 0)
            {
              //first time
              htmlcontent+='<h2>Utility Sensors:</h2>\n';
            }
            if (jj % rowItems == 0)
            {
              //add devider
              if (bHaveAddedDevider == true) {
                //close previous devider
                htmlcontent+='</div>\n';
              }
              htmlcontent+='<div class="row divider">\n';
              bHaveAddedDevider=true;
            }
            var xhtm="";
            if (data.DashboardType==0) {
							xhtm='\t<div class="4u" id="utility_' + item.idx +'">\n';
            }
            else {
							xhtm='\t<div class="3u" id="utility_' + item.idx +'">\n';
            }
            xhtm+='\t  <span>\n' +
                  '\t    <table id="itemtablesmall" border="0" cellpadding="0" cellspacing="0">\n' +
                  '\t    <tr>\n' +
                  '\t      <td id="name">' + item.Name + '</td>\n' +
                  '\t      <td id="img"><img src="images/';
									if (typeof item.Counter != 'undefined') {
										xhtm+='counter.png" height="40"></td>\n' +
										'\t      <td id="status">' + item.Counter + ', Today: ' + item.CounterToday;
									}
                  xhtm+=
                      '</td>\n' +
                      '\t      <td id="lastupdate">' + item.LastUpdate + '</td>\n' +
                  '\t    </tr>\n' +
                  '\t    </table>\n' +
                  '\t  </span>\n' +
                  '\t</div>\n';
            htmlcontent+=xhtm;
            jj+=1;
          }
        }); //Utility devices
        if (bHaveAddedDevider == true) {
          //close previous devider
          htmlcontent+='</div>\n';
        }

      }
     }
  });

	if (htmlcontent == "")
	{
    htmlcontent=
      '<h2>No favorite devices defined ... (Or communication Lost!)</h2><br>\n' +
      'If this is your first time here, please setup your <a href="javascript:SwitchLayout(\'Hardware\')">hardware</a>, and add some <a href="javascript:SwitchLayout(\'Devices\')">devices</a>.';
	}
	
	var suntext="";
  if (sunRise!="")
  {
    suntext+='SunRise: ' + sunRise + ', SunSet: ' + sunSet + '<br><br>\n';
  }
  $('#dashcontent').html(suntext+htmlcontent);

	//$("#dashcontent #light_12 #name").html("Kerstman!");

	if (!isiPhone()) {
		$("#dashcontent .4u").draggable({
				drag: function() {
					clearInterval($.myglobals.refreshTimer);
					$.devIdx=$(this).attr("id");
					$(this).css("z-index", 2);
				},
				revert: true
		});
		$("#dashcontent .4u").droppable({
				drop: function() {
					var myid=$(this).attr("id");
					var parts1 = myid.split('_');
					var parts2 = $.devIdx.split('_');
					if (parts1[0]!=parts2[0]) {
						alert('Only possible between Sensors of the same kind!');
						$.myglobals.refreshTimer = setInterval(ShowFavorites, 10000);
					} else {
					
						$.ajax({
							 url: "json.htm?type=command&param=switchdeviceorder&idx1=" + parts1[1] + "&idx2=" + parts2[1],
							 async: false, 
							 dataType: 'json',
							 success: function(data) {
									ShowFavorites();
							 }
						});
					}
				}
		});
		$("#dashcontent .3u").draggable({
				drag: function() {
					clearInterval($.myglobals.refreshTimer);
					$.devIdx=$(this).attr("id");
					$(this).css("z-index", 2);
				},
				revert: true
		});
		$("#dashcontent .3u").droppable({
				drop: function() {
					var myid=$(this).attr("id");
					var parts1 = myid.split('_');
					var parts2 = $.devIdx.split('_');
					if (parts1[0]!=parts2[0]) {
						alert('Only possible between Sensors of the same kind!');
						$.myglobals.refreshTimer = setInterval(ShowFavorites, 10000);
					} else {
					
						$.ajax({
							 url: "json.htm?type=command&param=switchdeviceorder&idx1=" + parts1[1] + "&idx2=" + parts2[1],
							 async: false, 
							 dataType: 'json',
							 success: function(data) {
									ShowFavorites();
							 }
						});
					}
				}
		});
	}
  $.myglobals.refreshTimer = setInterval(RefreshFavorites, 10000);
}

$(document).ready(function() {
  ShowFavorites();
} );
</script>