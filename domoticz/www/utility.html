<div id="dialog-addutilitydevice" title="Add Device">
    <form>
    <fieldset>
        <label for="name">Name: </label>
        <input type="text" id="devicename" style="width: 250px; padding: .4em;" class="text ui-widget-content ui-corner-all" />
    </fieldset>
    </form>
</div>
<div id="dialog-editutilitydevice" title="Edit Device">
    <form>
    <fieldset>
        <label for="name">Name: </label>
        <input type="text" id="devicename" style="width: 250px; padding: .4em;" class="text ui-widget-content ui-corner-all" />
    </fieldset>
    </form>
</div>
<div id="dialog-editmeterdevice" title="Edit Meter Device">
    <form>
    <fieldset>
        <table class="display" id="metertable" border="0" cellpadding="0" cellspacing="0">
        <tr>
          <td align="right" style="width:60px"><label for="name">Name: </label></td>
          <td><input type="text" id="devicename" style="width: 250px; padding: .4em;" class="text ui-widget-content ui-corner-all" /></td>
        <tr>
          <td align="right"><label for="metertype">Type: </label></td>
          <td><select id="combometertype" style="width:150px" class="combobox ui-corner-all">
            <!--#embed metertypes -->
          </select></td>
		    </tr>
		    </table>
    </fieldset>
    </form>
</div>

<div id="utilitycontent">
</div>
<div id="counterlog" style="display:none;">
  <h2>Week</h2><br>
  <div id="counterweekgraph" style="height: 300px;"></div>
  <br>
  <h2>Month</h2><br>
  <div id="countermonthgraph" style="height: 300px;"></div>
  <br>
  <h2>Year</h2><br>
  <div id="counteryeargraph" style="height: 300px;"></div>
</div>

<div id="smartlog" style="display:none;">
  <h2>Week</h2><br>
  <div id="counterweekgraph" style="height: 300px;"></div>
  <br>
  <h2>Month</h2><br>
  <div id="countermonthgraph" style="height: 300px;"></div>
  <br>
  <h2>Year</h2><br>
  <div id="counteryeargraph" style="height: 300px;"></div>
</div>

<script type="text/javascript" charset="utf-8">

function MakeFavorite(id,isfavorite)
{
	clearInterval($.myglobals.refreshTimer);
  $.ajax({
     url: "json.htm?type=command&param=makefavorite&idx=" + id + "&isfavorite=" + isfavorite, 
     async: false, 
     dataType: 'json',
     success: function(data) {
      ShowUtilities();
     }
  });
}

function EditUtilityDevice(idx,name)
{
	clearInterval($.myglobals.refreshTimer);
  $.devIdx=idx;
  $("#dialog-editutilitydevice #devicename").val(name);
  $( "#dialog-editutilitydevice" ).dialog( "open" );
}

function EditMeterDevice(idx,name, switchtype)
{
	clearInterval($.myglobals.refreshTimer);
  $.devIdx=idx;
  $("#dialog-editmeterdevice #devicename").val(name);
  $("#dialog-editmeterdevice #combometertype").val(switchtype);
  $( "#dialog-editmeterdevice" ).dialog( "open" );
}

function AddUtilityDevice()
{
  alert('todo, for now use the devices tab');
}

function AddDataToUtilityChart(data,chart,switchtype)
{
    var datatablev = [];
    var datatablereturn = [];

    $.each(data.result, function(i,item)
    {
       datatablev.push( [GetDateFromString(item.d), parseFloat(item.v) ] );
       if (typeof item.v2!= 'undefined') {
				datatablereturn.push( [GetDateFromString(item.d), parseFloat(item.v2) ] );
       }
    });

    var series;
    if (switchtype==0)
    {
			//energy Usage/Return
      chart.addSeries(
        {
          id: 'energy',
          name: 'Usage',
          color: 'rgba(3,190,252,0.8)',
          yAxis: 0
        }
      );
			chart.yAxis[0].axisTitle.attr({
        text: 'Energy kWh'
			});			
      series = chart.get('energy');
			chart.yAxis[0].redraw();
      series.setData(datatablev);

			if (typeof data.delivered!= 'undefined') {
				//energy return
				chart.addSeries(
					{
						id: 'energyreturn',
						name: 'Return',
						color: 'rgba(3,252,190,0.8)',
						yAxis: 0
					}
				);
				series = chart.get('energyreturn');
				chart.yAxis[0].redraw();
				series.setData(datatablereturn);
			}
    }
    else if (switchtype==1)
    {
			//gas
      chart.addSeries(
        {
          id: 'gas',
          name: 'Gas',
          color: 'rgba(3,190,252,0.8)',
          yAxis: 0
        }
      );
			chart.yAxis[0].axisTitle.attr({
        text: 'Gas m3'
			});			
      series = chart.get('gas');
      series.setData(datatablev);
    }
    else if (switchtype==2)
    {
			//water
      chart.addSeries(
        {
          id: 'water',
          name: 'Water',
          color: 'rgba(3,190,252,0.8)',
          yAxis: 0
        }
      );
			chart.yAxis[0].axisTitle.attr({
        text: 'Water m3'
			});			
      series = chart.get('water');
      series.setData(datatablev);
    }
}

function ShowCounterLog(id,name,switchtype)
{
	clearInterval($.myglobals.refreshTimer);
  $('#modal').show();
  var htmlcontent = '';
  htmlcontent='<p><center><h2>' + name + '</h2></center></p><br><br>\n';
  htmlcontent+=$('#counterlog').html();
  $('#utilitycontent').html(GetBackbuttonHTMLTable('ShowUtilities')+htmlcontent);
  
  $.WeekChart = new Highcharts.Chart({
      chart: {
          renderTo: 'counterweekgraph',
          type: 'column',
          marginRight: 10,
          events: {
              load: function() {
                  
                $.getJSON("json.htm?type=graph&sensor=counter&idx="+id+"&range=day",
                function(data) {
											AddDataToUtilityChart(data,$.WeekChart,switchtype);
                });
              }
          }
        },
       credits: {
          enabled: true,
          href: "http://www.domoticz.com",
          text: "Domoticz.com"
        },
        title: {
            text: 'Last week'
        },
        xAxis: {
            type: 'datetime',
            dateTimeLabelFormats: {
                day: '%a'
            },
            tickInterval: 24 * 3600 * 1000
        },
        yAxis: {
            title: {
                text: 'Energy (kWh)'
            },
            min: 0
        },
        tooltip: {
            formatter: function() {
										var unit = {
																'Usage': 'kWh',
																'Return': 'kWh',
																'Gas': 'm3',
																'Water': 'm3'
													}[this.series.name];
                    return this.series.name + ': ' + Highcharts.dateFormat('%Y-%m-%d', this.x) +': '+ this.y + ' ' + unit;
            }
        },
        plotOptions: {
            column: {
                minPointLength: 4,
                pointPadding: 0.1,
                groupPadding: 0
            }
        },
        legend: {
            enabled: false
        }
    });

  $.MonthChart = new Highcharts.Chart({
      chart: {
          renderTo: 'countermonthgraph',
          type: 'spline',
          marginRight: 10,
          events: {
              load: function() {
                  
                $.getJSON("json.htm?type=graph&sensor=counter&idx="+id+"&range=month",
                function(data) {
											AddDataToUtilityChart(data,$.MonthChart,switchtype);
                });
              }
          }
        },
       credits: {
          enabled: true,
          href: "http://www.domoticz.com",
          text: "Domoticz.com"
        },
        title: {
            text: 'Last Month'
        },
        xAxis: {
            type: 'datetime',
            tickInterval: 24 * 3600 * 1000
        },
        yAxis: {
            title: {
                text: 'Usage'
            },
            min: 0
        },
        tooltip: {
            formatter: function() {
										var unit = {
																'Usage': 'kWh',
																'Return': 'kWh',
																'Gas': 'm3',
																'Water': 'm3'
													}[this.series.name];
                    return this.series.name + ': ' + Highcharts.dateFormat('%Y-%m-%d', this.x) +': '+ this.y + ' ' + unit;
            }
        },
        plotOptions: {
           spline: {
                lineWidth: 3,
                states: {
                    hover: {
                        lineWidth: 3
                    }
                },
                marker: {
                    enabled: false,
                    states: {
                        hover: {
                            enabled: true,
                            symbol: 'circle',
                            radius: 5,
                            lineWidth: 1
                        }
                    }
                }
            }
        },
        legend: {
            enabled: false
        }
    });

  $.YearChart = new Highcharts.Chart({
      chart: {
          renderTo: 'counteryeargraph',
          type: 'spline',
          marginRight: 10,
          events: {
              load: function() {
                  
                $.getJSON("json.htm?type=graph&sensor=counter&idx="+id+"&range=year",
                function(data) {
											AddDataToUtilityChart(data,$.YearChart,switchtype);
                });
              }
          }
        },
       credits: {
          enabled: true,
          href: "http://www.domoticz.com",
          text: "Domoticz.com"
        },
        title: {
            text: 'Last Year'
        },
        xAxis: {
            type: 'datetime',
            tickInterval: 24 * 3600 * 1000
        },
        yAxis: {
            title: {
                text: 'Usage'
            },
            min: 0
        },
        tooltip: {
            formatter: function() {
										var unit = {
																'Usage': 'kWh',
																'Return': 'kWh',
																'Gas': 'm3',
																'Water': 'm3'
													}[this.series.name];
                    return this.series.name + ': ' + Highcharts.dateFormat('%Y-%m-%d', this.x) +': '+ this.y + ' ' + unit;
            }
        },
        plotOptions: {
           spline: {
                lineWidth: 3,
                states: {
                    hover: {
                        lineWidth: 3
                    }
                },
                marker: {
                    enabled: false,
                    states: {
                        hover: {
                            enabled: true,
                            symbol: 'circle',
                            radius: 5,
                            lineWidth: 1
                        }
                    }
                }
            }
        },
        legend: {
            enabled: false
        }
    });
}

function RefreshUtilities()
{
	clearInterval($.myglobals.refreshTimer);
  var id="";

  $.ajax({
     url: "json.htm?type=devices&filter=utility&used=true&order=Name", 
     async: false, 
     dataType: 'json',
     success: function(data) {
      if (typeof data.result != 'undefined') {
        $.each(data.result, function(i,item){
					id="#utilitycontent #" + item.idx;
					var obj=$(id);
					if (typeof obj != 'undefined') {
						if ($(id + " #name").html()!=item.Name) {
							$(id + " #name").html(item.Name);
						}
						var img="";
						var status="";
						
            if (typeof item.Counter != 'undefined') {
              img='<img src="images/counter.png" height="48">';
              status=item.Counter + ', Today: ' + item.CounterToday;
            }
            else if (item.Type == "Current") {
							img='<img src="images/current48.png" height="48">';
              status=item.Data;
            }
            else if (item.Type == "Energy") {
							img='<img src="images/current48.png" height="48">';
              status=item.Data;
            }
            if (typeof item.Usage != 'undefined') {
							status+=", Usage: " + item.Usage;
            }
            if (typeof item.CounterDeliv != 'undefined') {
							if (item.CounterDeliv!="0") {
								status+='<br>Return: ' + item.CounterDeliv + ', Today: ' + item.CounterDelivToday;
								status+=", Actual: " + item.UsageDeliv;
							}
            }
						
						if ($(id + " #img").html()!=img) {
							$(id + " #img").html(img);
						}
						if ($(id + " #status").html()!=status) {
							$(id + " #status").html(status);
						}
						if ($(id + " #lastupdate").html()!=item.LastUpdate) {
							$(id + " #lastupdate").html(item.LastUpdate);
						}
					}
        });
      }
     }
  });

	$.myglobals.refreshTimer = setInterval(RefreshUtilities, 10000);
}

function ShowUtilities()
{
	clearInterval($.myglobals.refreshTimer);
  $('#modal').show();
  
  var htmlcontent = '';
  var bHaveAddedDevider = false;

  var tophtm=
        '\t<table class="bannav" id="bannav" border="0" cellpadding="0" cellspacing="0" width="100%">\n' +
        '\t<tr>\n';
  tophtm+=
        '\t  <td align="right">\n' +
        '\t    <a class="btnstyle" onclick="AddUtilityDevice();">Add Sensor</a>\n' +
        '\t  </td>\n' +
        '\t</tr>\n' +
        '\t</table>\n';
  

  var i=0;
  $.ajax({
     url: "json.htm?type=devices&filter=utility&used=true&order=Name", 
     async: false, 
     dataType: 'json',
     success: function(data) {
      if (typeof data.result != 'undefined') {
        $.each(data.result, function(i,item){
          if (i % 3 == 0)
          {
            //add devider
            if (bHaveAddedDevider == true) {
              //close previous devider
              htmlcontent+='</div>\n';
            }
            htmlcontent+='<div class="row divider">\n';
            bHaveAddedDevider=true;
          }
          
          var xhtm=
                '\t<div class="4u" id="' + item.idx + '">\n' +
                '\t  <section>\n' +
                '\t    <table id="itemtable" border="0" cellpadding="0" cellspacing="0">\n' +
                '\t    <tr>\n' +
                '\t      <td id="name">' + item.Name + '</td>\n' +
                '\t      <td id="img"><img src="images/';
            var status="";
            if (typeof item.Counter != 'undefined') {
              xhtm+='counter.png" height="48"></td>\n';
              status=item.Counter + ', Today: ' + item.CounterToday;
            }
            else if (item.Type == "Current") {
              xhtm+='current48.png" height="48"></td>\n';
              status=item.Data;
            }
            else if (item.Type == "Energy") {
              xhtm+='current48.png" height="48"></td>\n';
              status=item.Data;
            }
            if (typeof item.Usage != 'undefined') {
							status+=", Usage: " + item.Usage;
            }
            if (typeof item.CounterDeliv != 'undefined') {
							if (item.CounterDeliv!="0") {
								status+='<br>Return: ' + item.CounterDeliv + ', Today: ' + item.CounterDelivToday;
								status+=", Actual: " + item.UsageDeliv;
							}
            }
            
						xhtm+=      
                '\t      <td id="status">' + status + '</td>\n' +
                '\t      <td id="lastupdate">' + item.LastUpdate + '</td>\n' +
                '\t      <td id="type">' + item.Type + ', ' + item.SubType + '</td>\n' +
                '\t      <td>';
          if (item.Favorite == 0) {
            xhtm+=      
                  '<img src="images/nofavorite.png" title="Add to Dashboard" onclick="MakeFavorite(' + item.idx + ',1);" onmouseover="cursorhand()" onmouseout="cursordefault()">&nbsp;&nbsp;&nbsp;&nbsp;';
          }
          else {
            xhtm+=      
                  '<img src="images/favorite.png" title="Remove from Dashboard" onclick="MakeFavorite(' + item.idx + ',0);" onmouseover="cursorhand()" onmouseout="cursordefault()">&nbsp;&nbsp;&nbsp;&nbsp;';
          }

          if (typeof item.Counter != 'undefined') {
            xhtm+='<a class="btnsmall" onclick="ShowCounterLog(' + item.idx + ',\'' + item.Name + '\', ' + item.SwitchTypeVal + ');">Log</a> ';
						xhtm+=      
									'<a class="btnsmall" onclick="EditMeterDevice(' + item.idx + ',\'' + item.Name + '\', ' + item.SwitchTypeVal +');">Edit</a> ';
          }
          else {
						xhtm+=      
									'<a class="btnsmall" onclick="EditUtilityDevice(' + item.idx + ',\'' + item.Name + '\');">Edit</a> ';
					}                
          if (item.Notifications == "true")
            xhtm+='<a class="btnsmall-sel" onclick="ShowNotifications(' + item.idx + ',\'' + item.Name + '\', \'#utilitycontent\', \'ShowUtilities\');">Notifications</a>';
          else
            xhtm+='<a class="btnsmall" onclick="ShowNotifications(' + item.idx + ',\'' + item.Name + '\', \'#utilitycontent\', \'ShowUtilities\');">Notifications</a>';

          xhtm+=      
                '</td>\n' +
                '\t    </tr>\n' +
                '\t    </table>\n' +
                '\t  </section>\n' +
                '\t</div>\n';
          htmlcontent+=xhtm;
        });
      }
     }
  });
  if (bHaveAddedDevider == true) {
    //close previous devider
    htmlcontent+='</div>\n';
  }
  if (htmlcontent == '')
  {
    htmlcontent='<h2>No Utility sensors found or added in the system...</h2>';
  }
  $('#modal').hide();
  $('#utilitycontent').html(tophtm+htmlcontent);

	if (!isiPhone()) {
		$("#utilitycontent .4u").draggable({
				drag: function() {
					clearInterval($.myglobals.refreshTimer);
					$.devIdx=$(this).attr("id");
					$(this).css("z-index", 2);
				},
				revert: true
		});
		$("#utilitycontent .4u").droppable({
				drop: function() {
					var myid=$(this).attr("id");
					$.devIdx.split(' ');
					$.ajax({
						 url: "json.htm?type=command&param=switchdeviceorder&idx1=" + myid + "&idx2=" + $.devIdx,
						 async: false, 
						 dataType: 'json',
						 success: function(data) {
								ShowUtilities();
						 }
					});
				}
		});
	}
	$.myglobals.refreshTimer = setInterval(RefreshUtilities, 10000);
  return false;
}

$(document).ready(function() {
    //global var
    $.devIdx=0;
    
    $( "#dialog-addutilitydevice" ).dialog({
          autoOpen: false,
          width: 350,
          height: 150,
          modal: true,
          resizable: false,
          buttons: {
              "Add Device": function() {
                  var bValid = true;
                  bValid = bValid && checkLength( $("#dialog-addutilitydevice #devicename"), 2, 100 );
                  if ( bValid ) {
                      $( this ).dialog( "close" );
                      $.ajax({
                         url: "json.htm?type=setused&idx=" + $.devIdx + '&name=' + $("#dialog-addutilitydevice #devicename").val() + '&used=true',
                         async: false, 
                         dataType: 'json',
                         success: function(data) {
                            ShowUtilities();
                         }
                      });
                      
                  }
              },
              Cancel: function() {
                  $( this ).dialog( "close" );
              }
          },
          open: function() {
              $(this).keypress(function(e) {
                if (e.keyCode == $.ui.keyCode.ENTER) {
                  e.preventDefault();
                  $(this).parent().find("button:eq(0)").trigger("click");
                }
              });
          },
          close: function() {
            $( this ).dialog( "close" );
          }
    });
    $( "#dialog-editutilitydevice" ).dialog({
          autoOpen: false,
          width: 350,
          height: 150,
          modal: true,
          resizable: false,
          buttons: {
              "Update": function() {
                  var bValid = true;
                  bValid = bValid && checkLength( $("#dialog-editutilitydevice #devicename"), 2, 100 );
                  if ( bValid ) {
                      $( this ).dialog( "close" );
                      $.ajax({
                         url: "json.htm?type=setused&idx=" + $.devIdx + '&name=' + $("#dialog-editutilitydevice #devicename").val() + '&used=true',
                         async: false, 
                         dataType: 'json',
                         success: function(data) {
                            ShowUtilities();
                         }
                      });
                      
                  }
              },
              "Remove Device": function() {
                  var bValid = false;
                  bValid=(confirm("Are you sure to remove this Device?")==true);
                  if ( bValid ) {
                      $( this ).dialog( "close" );
                      $.ajax({
                         url: "json.htm?type=setused&idx=" + $.devIdx + '&name=' + $("#dialog-editutilitydevice #devicename").val() + '&used=false',
                         async: false, 
                         dataType: 'json',
                         success: function(data) {
                            ShowUtilities();
                         }
                      });
                      
                  }
              },
              Cancel: function() {
                  $( this ).dialog( "close" );
              }
          },
          open: function() {
              $(this).keypress(function(e) {
                if (e.keyCode == $.ui.keyCode.ENTER) {
                  e.preventDefault();
                  $(this).parent().find("button:eq(0)").trigger("click");
                }
              });
          },
          close: function() {
            $( this ).dialog( "close" );
          }
    });
    $( "#dialog-editmeterdevice" ).dialog({
          autoOpen: false,
          width: 370,
          height: 200,
          modal: true,
          resizable: false,
          buttons: {
              "Update": function() {
                  var bValid = true;
                  bValid = bValid && checkLength( $("#dialog-editmeterdevice #devicename"), 2, 100 );
                  if ( bValid ) {
                      $( this ).dialog( "close" );
                      $.ajax({
                         url: "json.htm?type=setused&idx=" + $.devIdx + '&name=' + $("#dialog-editmeterdevice #devicename").val() + '&switchtype=' + $("#dialog-editmeterdevice #combometertype").val() + '&used=true',
                         async: false, 
                         dataType: 'json',
                         success: function(data) {
                            ShowUtilities();
                         }
                      });
                      
                  }
              },
              "Remove Device": function() {
                  var bValid = false;
                  bValid=(confirm("Are you sure to remove this Device?")==true);
                  if ( bValid ) {
                      $( this ).dialog( "close" );
                      $.ajax({
                         url: "json.htm?type=setused&idx=" + $.devIdx + '&name=' + $("#dialog-editmeterdevice #devicename").val() + '&used=false',
                         async: false, 
                         dataType: 'json',
                         success: function(data) {
                            ShowUtilities();
                         }
                      });
                      
                  }
              },
              Cancel: function() {
                  $( this ).dialog( "close" );
              }
          },
          open: function() {
              $(this).keypress(function(e) {
                if (e.keyCode == $.ui.keyCode.ENTER) {
                  e.preventDefault();
                  $(this).parent().find("button:eq(0)").trigger("click");
                }
              });
          },
          close: function() {
            $( this ).dialog( "close" );
          }
    });

  ShowUtilities();
 
} );  
</script>
