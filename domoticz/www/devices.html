<div id="dialog-adddevice" title="Add Device">
    <form>
    <fieldset>
        <label for="name">Name: </label>
        <input type="text" id="devicename" style="width: 250px; padding: .2em;" class="text ui-widget-content ui-corner-all" />
    </fieldset>
    </form>
</div>
<div id="dialog-addlightdevice" title="Add Light/Switch Device">
    <form>
    <fieldset>
        <table class="display" id="lighttable" border="0" cellpadding="0" cellspacing="0">
        <tr>
          <td align="right" style="width:60px"><label for="name">Name: </label></td>
          <td><input type="text" id="devicename" style="width: 250px; padding: .2em;" class="text ui-widget-content ui-corner-all" /></td>
        <tr>
          <td align="right"><label>As: </label></td>
          <td><input type="radio" name="how" id="how_1" value="New" checked>&nbsp;Main Device&nbsp;&nbsp;<input type="radio" name="how" id="how_2" value="Sub Device">&nbsp;Sub/Slave Device</td>
        <tr>
				<tr id="subdevice" style="display:none">
					<td align="right" style="width:60px"><label>Device: </label></td>
					<td>
						<select id="combosubdevice" style="width:250px" class="combobox ui-corner-all">
						</select>
					</td>
				</tr>
				</table>
    </fieldset>
    </form>
</div>
<div id="devicescontent">
</div>
<div id="devicestable" style="display:none;">
		<table class="bannav" id="bannav" border="0" cellpadding="0" cellspacing="0" width="100%">
		<tr>
			<td align="Left" style="width:100px">
				<a id="mUsed" class="btnstyle3" onclick="ShowDevices('used');">Used</a>
			</td>
			<td align="center">
				<a id="mAll" class="btnstyle3-sel" onclick="ShowDevices('all');">All Devices</a>
			</td>
			<td align="right" style="width:100px">
				<a id="mUnknown" class="btnstyle3" onclick="ShowDevices('unknown');">Not Used</a>
			</td>
		</tr>
		</table>
		<br>
		<table class="display" id="devices" border="0" cellpadding="0" cellspacing="0" width="100%">
				<thead>
						<tr>
								<th width="20"></th>
								<th width="100" align="left">Hardware</th>
								<th width="80" align="left">ID</th>
								<th width="50" align="center">Unit</th>
								<th width="200" align="left">Name</th>
								<th width="150">Type</th>
								<th width="80">SubType</th>
								<th>Data</th>
								<th width="70"></th>
								<th width="140" align="left">Last Seen</th>
						</tr>
				</thead>
		</table>
</div>
<script type="text/javascript" charset="utf-8">

function AddDevice(idx)
{
    $.devIdx = idx;
    $( "#dialog-adddevice" ).dialog( "open" );
}

function AddLightDevice(idx)
{
    $.devIdx = idx;
    
    $("#dialog-addlightdevice #combosubdevice").html("");
    
		$.each($.LightsAndSwitches, function(i,item){
			var option = $('<option />');
			option.attr('value', item.idx).text(item.name);
			$("#dialog-addlightdevice #combosubdevice").append(option);
		});
    
    $( "#dialog-addlightdevice" ).dialog( "open" );
}

function RemoveDevice(idx)
{
  if (confirm("Are you sure to remove this Device from your used devices?")==false) {
    return;
  }
    $.ajax({
       url: "json.htm?type=setused&idx=" + idx + '&used=false',
       async: false, 
       dataType: 'json',
       success: function(data) {
          ShowDevices();
       }
    });
}

function DeleteDevice(idx)
{
  if (confirm("Are you sure to delete this Device?")==false) {
    return;
  }
    $.ajax({
       url: "json.htm?type=deletedevice&idx=" + idx,
       async: false, 
       dataType: 'json',
       success: function(data) {
          ShowDevices();
       }
    });
    
}

function RefreshLightSwitchesComboArray()
{
	$.LightsAndSwitches = [];
  $.ajax({
     url: "json.htm?type=command&param=getlightswitches", 
     async: false, 
     dataType: 'json',
     success: function(data) {
      if (typeof data.result != 'undefined') {
        $.each(data.result, function(i,item){
					$.LightsAndSwitches.push({
							idx: item.idx,
							name: item.Name
						 }
					);
        });
      }
     }
  });
}

function ShowDevices(filter)
{
	if (typeof filter != 'undefined') {
		$.DevicesFilter=filter;
	}
	else {
		if (typeof $.DevicesFilter != 'undefined') {
			filter=$.DevicesFilter;
		}
	}
  $('#modal').show();
  
  RefreshLightSwitchesComboArray();
  
  $("#devicestable #mUsed").attr('class', 'btnstyle3');
  $("#devicestable #mAll").attr('class', 'btnstyle3');
  $("#devicestable #mUnknown").attr('class', 'btnstyle3');
 
  var ifilter="all";
  if (typeof filter != 'undefined') {
    if (filter == "used") {
      ifilter = "true";
			$("#devicestable #mUsed").attr('class', 'btnstyle3-sel');
    }
    else if (filter == "unknown") {
			$("#devicestable #mUnknown").attr('class', 'btnstyle3-sel');
      ifilter = "false";
    }
    else if (filter == "all") {
			$("#devicestable #mAll").attr('class', 'btnstyle3-sel');
      ifilter = "all";
    }
  }
  else {
      ChangeClass("mAll","btnstyle3-sel");
  }
  
  var htmlcontent = '';
  htmlcontent+=$('#devicestable').html();
  $('#devicescontent').html(htmlcontent);

	$('#devicescontent #devices').dataTable( {
		"sDom": '<"H"lfrC>t<"F"ip>',
		"oTableTools": {
			"sRowSelect": "single"
		},
		"aoColumnDefs": [
			{ "bSortable": false, "aTargets": [ 0,7,8 ] }
		],
		"aaSorting": [[ 9, "desc" ]],
		"bSortClasses": false,
		"bProcessing": true,
		"bStateSave": true,
		"bJQueryUI": true,
		"aLengthMenu": [[25, 50, 100, -1], [25, 50, 100, "All"]],
		"iDisplayLength" : 25,
		"sPaginationType": "full_numbers"
	} );

	var mTable = $('#devicescontent #devices');
  var oTable = mTable.dataTable();
  oTable.fnClearTable();
  
  $.ajax({
     url: "json.htm?type=devices&used=" + ifilter, 
     async: false, 
     dataType: 'json',
     success: function(data) {
      if (typeof data.result != 'undefined') {
        $.each(data.result, function(i,item){
          var itemSubIcons="";
          var TypeImg=item.TypeImg;
          var itemImage='<img src="images/' + TypeImg + '.png">';
          if (TypeImg.indexOf("lightbulb")==0) {
							if (
									(item.Status == 'On')||
									(item.Status == 'Chime')||
									(item.Status == 'Group On')||
									(item.Status.indexOf('Set ') == 0)
								 ) {
											itemImage='<img src="images/lightbulb.png" title="Turn Off" onclick="SwitchLight(' + item.idx + ',\'Off\',ShowDevices);" onmouseover="cursorhand()" onmouseout="cursordefault()">';
							}
							else {
											itemImage='<img src="images/lightbulboff.png" title="Turn On" onclick="SwitchLight(' + item.idx + ',\'On\',ShowDevices);" onmouseover="cursorhand()" onmouseout="cursordefault()">';
							}
          }
          if (item.Used!=0) {
            itemSubIcons+='<img src="images/remove.png" title="Remove Device" onclick="RemoveDevice(' + item.idx +')">';
          }
          else {
						if (
								(item.Type.indexOf("Light")==0)||
								(item.Type.indexOf("Security")==0)
							 )
						{
							itemSubIcons+='<img src="images/add.png" title="Add Light/Switch Device" onclick="AddLightDevice(' + item.idx +')">';
						}
						else {
							itemSubIcons+='<img src="images/add.png" title="Add Device" onclick="AddDevice(' + item.idx +')">';
						}
          }
          if (
							(item.Type.indexOf("Light")==0)||
							(item.Type.indexOf("Security")==0)
						 )
          {
            itemSubIcons+='&nbsp;<img src="images/log.png" title="Log" onclick="ShowLightLog(' + item.idx + ',\'' + item.Name  + '\', \'#devicescontent\', \'ShowDevices\');">';
          }
          else
						itemSubIcons+='&nbsp;<img src="images/empty16.png">';
          var ID = item.ID;
          if (item.Type=="Lighting 1") {
						ID = String.fromCharCode(item.ID);
          }
          itemSubIcons+='&nbsp;<img src="images/delete.png" title="Delete Device" onclick="DeleteDevice(' + item.idx +')">';
          var addId = oTable.fnAddData([
                      itemImage,
                      item.HardwareName,
                      ID,
                      item.Unit,
                      item.Name,
                      item.Type,
                      item.SubType,
                      item.Data,
                      itemSubIcons,
                      item.LastUpdate
                    ], false);
        });
        mTable.fnDraw();
      }
     }
  });
  $('#modal').hide();
  return false;
}

function EnableDisableSubDevices(bEnabled)
{
	var trow=$("#dialog-addlightdevice #lighttable #subdevice");
	if (bEnabled == true) {
		trow.show();
	}
	else {
		trow.hide();
	}
}

$(document).ready(function() {
    //global var
    $.devIdx=0;
    $.LightsAndSwitches = [];
			
        $( "#dialog-adddevice" ).dialog({
              autoOpen: false,
              width: 350,
              height: 150,
              modal: true,
              resizable: false,
              buttons: {
                  "Add Device": function() {
                      var bValid = true;
                      bValid = bValid && checkLength( $("#dialog-adddevice #devicename"), 2, 100 );
                      if ( bValid ) {
                          $( this ).dialog( "close" );
                          $.ajax({
                             url: "json.htm?type=setused&idx=" + $.devIdx + '&name=' + $("#dialog-adddevice #devicename").val() + '&used=true',
                             async: false, 
                             dataType: 'json',
                             success: function(data) {
                                ShowDevices();
                             }
                          });
                          
                      }
                  },
                  Cancel: function() {
                      $( this ).dialog( "close" );
                  }
              },
              open: function() {
                  $(this).keypress(function(e) {
                    if (e.keyCode == $.ui.keyCode.ENTER) {
                      e.preventDefault();
                      $(this).parent().find("button:eq(0)").trigger("click");
                    }
                  });
              },
              close: function() {
                $( this ).dialog( "close" );
              }
        });

        $( "#dialog-addlightdevice" ).dialog({
              autoOpen: false,
              width: 360,
              height: 206,
              modal: true,
              resizable: false,
              buttons: {
                  "Add Device": function() {
                      var bValid = true;
                      bValid = bValid && checkLength( $("#dialog-addlightdevice #devicename"), 2, 100 );
                      var bIsSubDevice=$("#dialog-addlightdevice #lighttable #how_2").attr('checked')?true:false;
                      var MainDeviceIdx="";
                      if (bIsSubDevice)
                      {
												var MainDeviceIdx=$("#dialog-addlightdevice #combosubdevice option:selected").val();
												if (typeof MainDeviceIdx == 'undefined') {
													alert('No Main Device Selected!');
													return;
												}
                      }
                      if ( bValid ) {
                          $( this ).dialog( "close" );
                          $.ajax({
                             url: "json.htm?type=setused&idx=" + $.devIdx + '&name=' + $("#dialog-addlightdevice #devicename").val() + '&used=true&maindeviceidx=' + MainDeviceIdx,
                             async: false, 
                             dataType: 'json',
                             success: function(data) {
                                ShowDevices();
                             }
                          });
                      }
                  },
                  Cancel: function() {
                      $( this ).dialog( "close" );
                  }
              },
              open: function() {
                  $(this).keypress(function(e) {
                    if (e.keyCode == $.ui.keyCode.ENTER) {
                      e.preventDefault();
                      $(this).parent().find("button:eq(0)").trigger("click");
                    }
                  });
              },
              close: function() {
                $( this ).dialog( "close" );
              }
        });
				
				$("#dialog-addlightdevice #lighttable #how_1").click(function() {
					EnableDisableSubDevices(false);
				});
				$("#dialog-addlightdevice #lighttable #how_2").click(function() {
					EnableDisableSubDevices(true);
				});
				
				ShowDevices();
} );  
</script>