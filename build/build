#!/bin/sh

usage() { 
	echo "Usage: $0 init ]" 1>&2
	echo "Usage: $0 open-zwave [ clean | check | test | updateIndexDefines ]" 1>&2
	echo "Usage: $0 domoticz [ clean | cmake | run ] [ arguments ]" 1>&2
	echo "Usage: $0 shell ]" 1>&2
	exit 1
}

if [ $# -eq 0 ]; then
	usage
fi

# We need CMake version 3.16.0 or higher, so build it from source
CMAKE_VERSION=3.19.3

# Its recommended that you use the latest Boost libraries
BOOST_VERSION=1.75.0

BUILD_ROOT=$(dirname "$0")
OPENZWAVE_ROOT="${BUILD_ROOT}/../../open-zwave"

DOCKER_IMAGE="domoticz/domoticz-build"

if [ ! -d $OPENZWAVE_ROOT ]; then
	echo "OpenZWave source missing"
	echo "You might need to to something like: git clone https://github.com/OpenZWave/open-zwave ${OPENZWAVE_ROOT}"
	exit 1
fi

if [ "$(uname)" == "Darwin" ]; then
    OS=macos      
elif [ "$(expr substr $(uname -s) 1 5)" == "Linux" ]; then
    OS=linux
elif [ "$(expr substr $(uname -s) 1 5)" == "MINGW" ]; then
    OS=windows
else
	echo "Unknown OS $(uname -s), aborting"
	exit 1
fi

if [ "$1" = "init" ]; then
	docker-compose -f ${BUILD_ROOT}/docker-compose.yml build \
	  --build-arg CMAKE_VERSION=${CMAKE_VERSION} \
	  --build-arg BOOST_VERSION=${BOOST_VERSION} \
	  --build-arg BOOST_VERSION_=$(echo ${BOOST_VERSION} | tr . _)
else
	docker-compose -f ${BUILD_ROOT}/docker-compose.yml run --service-ports \
	  -e HOST_OS=${OS} \
	  domoticz $*
fi
