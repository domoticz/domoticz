#!/bin/sh

usage() { 
	echo "Usage: $0 open-zwave [ clean | check | test| updateIndexDefines]" 1>&2
	echo "Usage: $0 domoticz [ clean | cmake | run ]" 1>&2
	exit 1
}

if [ $# -eq 0 -o $# -gt 2 ]; then
	usage
fi

BUILD_ROOT="$(cd "$(dirname "$0")" && pwd -P)"
DOMOTICZ_ROOT="${BUILD_ROOT}/.."
OPENZWAVE_ROOT="${BUILD_ROOT}/../../open-zwave"

if [ ! -d $OPENZWAVE_ROOT ]; then
	echo "Open Zwave source missing"
	echo "You might need to to something like: git clone https://github.com/OpenZWave/open-zwave ${OPENZWAVE_ROOT}"
	exit 1
fi

if [ "$(uname)" == "Darwin" ]; then
    OS=macos      
elif [ "$(expr substr $(uname -s) 1 5)" == "Linux" ]; then
    OS=linux
elif [ "$(expr substr $(uname -s) 1 5)" == "MINGW" ]; then
    OS=windows
else
	echo "Unknown OS $(uname -s), aborting"
	exit 1
fi

if [ "$2" = "run" ]; then
	DOCKER_ARGS="-p 8080:8080"
else
	DOCKER_ARGS=""
fi

# Before using this script you need to build the docker image like:
# 
# docker build -t markr/domoticz-build .

docker run --rm -it ${DOCKER_ARGS} \
--env HOST_OS=${OS} \
--mount type=bind,source="${OPENZWAVE_ROOT}",target=/root/open-zwave \
--mount type=bind,source="${DOMOTICZ_ROOT}",target=/root/domoticz \
--mount type=bind,source="${BUILD_ROOT}/build-helper.sh",target=/root/build-helper.sh,readonly \
--mount source=build,target=/root/build \
markr/domoticz-build \
/root/build-helper.sh $*
