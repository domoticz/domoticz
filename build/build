#!/bin/sh

usage() { 
	cat <<HERE
Usage:
  $0 init                              # build the Docker image
  $0 clean [-p openzwave | domoticz]   # clean source
  $0 compile [-p openzwave | domoticz] # compile source
  $0 shell                             # run bash inside the container

Only for Domoticz:
  $0 cmake                             # (re)creates Makefiles
  $0 run                               # run Domoticz for testing

Only for OpenZWave:
  $0 check                             # validates XML configuration files
  $0 updateIndexDefines
  $0 test
HERE
	exit 1
}

if [ $# -eq 0 -o "$1" = "-h" -o "$1" = "--help" ]; then
	usage
fi

# We need CMake version 3.16.0 or higher, so build it from source
CMAKE_VERSION=3.19.3

# Its recommended that you use the latest Boost libraries
BOOST_VERSION=1.75.0

BUILD_ROOT=$(dirname "$0")
OPENZWAVE_ROOT="${BUILD_ROOT}/../../open-zwave"

if [ ! -d $OPENZWAVE_ROOT ]; then
	echo "OpenZWave source missing"
	echo "You might need to to something like: git clone https://github.com/OpenZWave/open-zwave ${OPENZWAVE_ROOT}"
	exit 1
fi

if [ "$(uname)" == "Darwin" ]; then
    OS=macos      
elif [ "$(expr substr $(uname -s) 1 5)" == "Linux" ]; then
    OS=linux
elif [ "$(expr substr $(uname -s) 1 5)" == "MINGW" ]; then
    OS=windows
else
	echo "Unknown OS $(uname -s), aborting"
	exit 1
fi

if [ "$1" = "init" ]; then
	docker-compose -f ${BUILD_ROOT}/docker-compose.yml \
	  build \
	  --build-arg CMAKE_VERSION=${CMAKE_VERSION} \
	  --build-arg BOOST_VERSION=${BOOST_VERSION} \
	  --build-arg BOOST_VERSION_=$(echo ${BOOST_VERSION} | tr . _)
else
	docker-compose -f ${BUILD_ROOT}/docker-compose.yml \
	  run \
	  --rm \
	  --service-ports \
	  domoticz -o ${OS} $*
fi
