<!DOCTYPE HTML>
<html manifest="../html5.appcache" lang="en-US">
<head>
	
	<meta charset="UTF-8">
	<title>Domoticz Security Panel</title>
		
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="viewport" content="width=600">

	<link href="css/style.css" rel="stylesheet" />
	
	<script src="../js/jquery-1.12.0.min.js"></script>
	<script src="../js/i18next-1.8.0.min.js"></script> 
	<script src="../js/domoticz.js"></script>
	<script src="../js/md5.js"></script>
	
	<script src="js/ion.sound.min.js"></script>
	
	<script type="text/javascript">

		/* global ion, $, MakeDatatableTranslations, SecurityPanel, md5 */
		
		var SecurityPanel = function () {
		    
			var secPanel = {
				heartbeatIntervalSecs: 10,
				secOnDelay: 30,
				heartbeatTimer: undefined,
				code: ""/*,
				zones: []*/
			};
		
			function Show(text) {
				$('#digitdisplay').val(("* " + $.i18n.t(text) + " *").toUpperCase());
			}
			function ShowError(error) {
				if (error=="NoConnect") {
					Show("Disconnected");
				}
				else if (error=="NoOkData") {
					Show($.i18n.t("Disconnected"));
				}
				else if (error=="NoSettingsData") {
					Show($.i18n.t("Disconnected"));
				}
				else if (error=="NoOkCode") {
					Show($.i18n.t("WRONG CODE"));
				}
				else {
					Show($.i18n.t("Disconnected"));
				}
			}
		
			function ResetHeartbeat(nonstandardDelayMs, keepCode) {
		
				var delay = secPanel.heartbeatIntervalSecs * 1000;
				
				// Make sure any previous calls are ignored
				clearTimeout(secPanel.heartbeatTimer);
		
				// Use nonstandardDelayMs if defined
				nonstandardDelayMs = parseInt(nonstandardDelayMs, 10);
				if (!isNaN(nonstandardDelayMs)) {
					delay = nonstandardDelayMs;
				}
				
				// Clear code, unless instructed not to
				if (!keepCode) {
					secPanel.code = "";
				}
				
				// New request
				secPanel.heartbeatTimer = setTimeout(function () {
					Heartbeat();
				}, delay);
				
			}
		
			function RefreshStatus(callback) {
		
				// Upate security status
				$.ajax({
					url: "../json.htm?type=command&param=getsecstatus",
					dataType: 'json',
					success: function(data) {
						if (data.status != "OK") {
							ShowError('NoOkData');
						}
						else {
							
							// Update status
							var displaytext="";
							if (data.secstatus==0) displaytext="Disarmed";
							else if (data.secstatus==1) displaytext="Armed Home";
							else if (data.secstatus==2) displaytext="Armed";
							else displaytext="Unknown Error";
							
							Show(displaytext);
							
							// Update SecOnDelay
							var parsedSecOnDelay = parseInt(data.secondelay, 10);
							if (!isNaN(parsedSecOnDelay)) {
								secPanel.secOnDelay = parsedSecOnDelay;
							}
							
						}
						
						callback();
					},
					error: function(data){
						if (data.status==401) { // 401 : Unauthorized
							window.location = "../index.html";
						}
						
						callback();
					}
				});
			}
		
			function Heartbeat() {
		
				RefreshStatus(function () {
		
					// RefreshZones();
		
					// Iterate!
					ResetHeartbeat();
		
				});
		
			}
			
			function Countdown(delay) {
		
				clearTimeout(secPanel.countdownTimer);
		
				// Make the heartbeat wait a while
				ResetHeartbeat();
		
				if (delay > 1) {
		
					delay = delay - 1;
					Beep('set');
					$('#digitdisplay').val($.i18n.t('Delay') + ': ' + delay);
		
					secPanel.countdownTimer = setTimeout(function () { Countdown (delay); }, 1000);
		
				} else {
		
					Beep('in');
					ResetHeartbeat(0);
		
				}
			}
			
			function Beep(tone) {
				if (tone=="error") {
					ion.sound.play("wrongcode");
				}
				else if (tone=="set") {
					ion.sound.play("key");
				}
				else if (tone=="in") {
					ion.sound.play("arm");
				}
				else if (tone=="out") {
					ion.sound.play("disarm");
				}
				else {
					ion.sound.play("key");
				}
			}
			
			function SetSecStatus (status) {
		
				// Bail out if stuff doesn't seem right
				if (isNaN(status)) {
					Beep('error');
					return;
				}
				
				// Temporary storage
				var seccodeHash = md5(secPanel.code);
		
				// Make the heartbeat wait a while (secPanel.code is reset here)
				ResetHeartbeat();
		
				$.ajax({
					url: "../json.htm?type=command&param=setsecstatus&secstatus=" + status + "&seccode=" + seccodeHash,
					dataType: 'json',
					success: function(data) {
						if (data.status != "OK") {
							if (data.message=="WRONG CODE") {
								ShowError('NoOkCode');
								Beep('error');
								ResetHeartbeat(3000);
							}
							else {
								ShowError('NoOkData');
								ResetHeartbeat(3000);
							}
						}
						else {
							if (status==1 || status==2) {
								Countdown(secPanel.secOnDelay);
							}
							else {
								ResetHeartbeat(0);
								Beep('out');
							}
						}
					},
					error: function(){
						ShowError('NoConnect');
						return;
					}
				});
				seccodeHash = undefined;
			}
			
			function AddDigit(digit) {
		
				Beep(); 
				
				// Make the heartbeat wait a whild
				// Note: Heartbeat always resets the cleartext code placeholder (secStatus.code)
				ResetHeartbeat(undefined, true);
		
				// Only proceed if new digit is a digit, inside range 0-9
				var newDigit = parseInt(digit, 10);
				if ((newDigit >= 0 && newDigit <= 9) || digit == "*" || digit == "#") {
		
		            // Update code
					secPanel.code = "" + secPanel.code + "" + digit;
					
					// Update display
		    		$('#digitdisplay').val(secPanel.code.replace(/./g,"#"));
		
				}
				
			}
			
		 	return {
		 		AddDigit: AddDigit,
				SetSecStatus: SetSecStatus,
				Beep: Beep,
				ResetHeartbeat: ResetHeartbeat,
				Start: Heartbeat
		 	};
				 	
		};
		
		// Deprecated code, left for future use
		
			/*function RefreshZones(callback) {
		
				$.ajax({
					url: "../json.htm?type=command&param=getlightswitches",
					dataType: 'json',
					success: function(data) {
						if (data.status != "OK") {
							ShowError('NoOkData');
							return;
						}
						else {
							var idxnumbers=[];
							if (typeof(data.result) != "undefined") {
								$.each(data.result, function(i,item) {
									if (item.Name.toLowerCase().indexOf('alarm zone')==0) idxnumbers[idxnumbers.length]=item.idx;
								});
							}
							secPanel.zones = idxnumbers;
							callback(idxnumbers);
						}
					},
					error: function(){
						ShowError('NoConnect');
						callback();
					}
				});
			}*/
			// check if provided zone idx number(s) is/are clear
			/*function CheckZoneClear(zonearray) {
				var openzone=false;
				if (typeof(zonearray) != "undefined") {
					$.each(zonearray, function(i,item) {
						$.ajax({
							url: "../json.htm?type=devices&rid="+item,
							async: false, 
							dataType: 'json',
							success: function(data) {
								if (data.status != "OK") {
									ShowError('NoOkData');
									return;
								}
								else {
									if (typeof(data.result) != "undefined") {
										$.each(data.result, function(j,zone) {
											if (zone.Status=='On') openzone=true;
										});
									}
									return openzone;
								}
							},
							error: function(){
								ShowError('NoConnect');
								return;
							}
						});
					});
				}
				return openzone;
			}*/
			
			
			// SetSecStatus
			
				/*if (typeof(zonearray) != "undefined") {
					if (CheckZoneClear(zonearray)) {
						Beep('error');
						$('#digitdisplay').val(('* ZONE OPEN *'));
						CodeSetTimer=DelayedStatusRefresh(3000);
						return;
					}
				}*/

		// Set up sound
		ion.sound({
			sounds: [
				{name: "arm"},
				{name: "disarm"},
				{name: "key"},
				{name: "wrongcode"}
			],
			// main config
			path: "media/",
			preload: true,
			multiplay: true,
			volume: 0.9
		});
		
		// Set up securitypanel
		var securityPanel = SecurityPanel();
		
		// Setup translation
		function SetLanguageEx(lng) {
			
			$.i18n.init({
				resGetPath: '/i18n/domoticz-__lng__.json',
				fallbackLng: false,
				getAsync: false,
				debug: false,
				useCookie: false,
				nsseparator: 'aadd',
				keyseparator: 'bbcc',
				lng: lng
			});
			
			$('.translate').each(function(i, elm) {
				var e = $(elm);
				e.text($.i18n.t(e.text()));
			});
			
		}

		// DOM is ready, go go go!
		$(document).ready(function() {

			// Determine languange
			var lang = 'en';
			if(window.location.hash) {
				var hash = window.location.hash.substring(1);

				if(hash) {
					lang = hash;
				} 
			}
			
			SetLanguageEx(lang);
			
		 	// Entrypoint for "main loop"
		 	securityPanel.Start();
			 	
			// Setup events
			$('li.digit').on('touchstart click', function (e) {
				e.preventDefault();
				
				// Digit
				var 
					target = $(e.target),
					digit = target.data('digit');
				securityPanel.AddDigit(digit);
				
			});
			
			$('li.arm').on('touchstart click', function (e) {
				e.preventDefault();
				
				// Digit
				var 
					target = $(e.target),
					secstatus = target.data('secstatus'),
					secstatusParsed = parseInt(secstatus, 10);
				if(!isNaN(secstatusParsed)) {
					securityPanel.SetSecStatus(secstatusParsed);
				}
				
			});

			$('li.cancel').on('touchstart click', function (e) {
				e.preventDefault();
				
				// Update immediately
				securityPanel.Beep('out');
				securityPanel.ResetHeartbeat(0);
			});
			
		});

	</script>
</head>
<body>
	<div id="main">
		<div class="main-border">
			<div id="keypad">
				<div class="keypad-header">
					<div class="title fullscreen"><p>Domoticz Security Panel</p></div>
				</div>
				<form name="keypadinput">
					<input type="text" id="digitdisplay" value="" name="digitdisplay" disabled="disabled"/>
					<ul class="keypad-keys">
						<li class="digit" data-digit="1">1</li>
						<li class="digit" data-digit="2">2</li>
						<li class="digit" data-digit="3">3</li>
						<li class="arm disarm translate" data-secstatus="0">Disarm</li>
					</ul>
					<ul class="keypad-keys">
						<li class="digit" data-digit="4">4</li>
						<li class="digit" data-digit="5">5</li>
						<li class="digit" data-digit="6">6</li>
						<li class="arm translate" data-secstatus="1">Home</li>
					</ul>
					<ul class="keypad-keys">
						<li class="digit" data-digit="7">7</li>
						<li class="digit" data-digit="8">8</li>
						<li class="digit" data-digit="9">9</li>
						<li class="arm translate" data-secstatus="2">Away</li>
					</ul>
					<ul class="keypad-keys">
						<li class="digit" data-digit="*">*</li>
						<li class="digit" data-digit="0">0</li>
						<li class="digit" data-digit="#">#</li>
						<li class="arm cancel translate">Cancel</li>
					</ul>
				</form>
			</div>
		</div>
	</div>
</body>
</html>
